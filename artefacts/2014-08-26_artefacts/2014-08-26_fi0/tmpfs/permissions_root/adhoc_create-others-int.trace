###########################################
# Testing mkdir and creating files
# with group permissions
###########################################

# these tests create parent-directories with various permissions and
# then try to create files and directories inside these parent
# directories while being not the owner of the dir and not in the group
# of it.  
# This should only work, if one has search and 
# write permission to the parent dir. However, the search permission
# is also needed needed for path resolution. The tests therefore also
# try to create the files in the current working directory. 
# before removing x permission.

###################################
# Initialising processes and users
###################################

# Pid 1 runs as root, we need 3 more processes that run 
# as non-superusers. The idea is to have 
#
# - Pid 2 : creates and owns the directories
# - Pid 3 : tries to create the files while 
#           being in the right group but not the owner

create Pid 2 (User_id 1) (Group_id 1)
add_user_to_group (User_id 1) (Group_id 1)

# Pid 3 runs as different user in the group of User 1
create Pid 3 (User_id 2) (Group_id 2)
add_user_to_group (User_id 2) (Group_id 2)

# make sure the permissions below get not modified by umask
Pid 2 -> umask 0o000
Pid 3 -> umask 0o000


###################################
# The tests
###################################

# rwx
Pid 2 -> mkdir /dir_rwx/ 0o777
Pid 2 -> chdir /dir_rwx
Pid 3 -> chdir /dir_rwx
Pid 2 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> open_close f4 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> mkdir d2 0o777
Pid 2 -> mkdir d4 0o777
Pid 2 -> chmod /dir_rwx/ ------rwx

Pid 3 -> mkdir d1 0o777
Pid 3 -> mkdir d2 0o777
Pid 3 -> open_close f1 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> mkdir /dir_rwx/d3 0o777
Pid 3 -> mkdir /dir_rwx/d4 0o777
Pid 3 -> open_close /dir_rwx/f3 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close /dir_rwx/f4 [O_RDWR;O_CREAT;O_EXCL] 0o666


# rw_
Pid 2 -> mkdir /dir_rw_/ 0o777
Pid 2 -> chdir /dir_rw_
Pid 3 -> chdir /dir_rw_
Pid 2 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> open_close f4 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> mkdir d2 0o777
Pid 2 -> mkdir d4 0o777
Pid 2 -> chmod /dir_rw_/ ------rw-

Pid 3 -> mkdir d1 0o777
Pid 3 -> mkdir d2 0o777
Pid 3 -> open_close f1 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> mkdir /dir_rw_/d3 0o777
Pid 3 -> mkdir /dir_rw_/d4 0o777
Pid 3 -> open_close /dir_rw_/f3 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close /dir_rw_/f4 [O_RDWR;O_CREAT;O_EXCL] 0o666


# r_x
Pid 2 -> mkdir /dir_r_x/ 0o777
Pid 2 -> chdir /dir_r_x
Pid 3 -> chdir /dir_r_x
Pid 2 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> open_close f4 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> mkdir d2 0o777
Pid 2 -> mkdir d4 0o777
Pid 2 -> chmod /dir_r_x/ ------r-x

Pid 3 -> mkdir d1 0o777
Pid 3 -> mkdir d2 0o777
Pid 3 -> open_close f1 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> mkdir /dir_r_x/d3 0o777
Pid 3 -> mkdir /dir_r_x/d4 0o777
Pid 3 -> open_close /dir_r_x/f3 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close /dir_r_x/f4 [O_RDWR;O_CREAT;O_EXCL] 0o666


# r__
Pid 2 -> mkdir /dir_r__/ 0o777
Pid 2 -> chdir /dir_r__
Pid 3 -> chdir /dir_r__
Pid 2 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> open_close f4 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> mkdir d2 0o777
Pid 2 -> mkdir d4 0o777
Pid 2 -> chmod /dir_r__/ ------r--

Pid 3 -> mkdir d1 0o777
Pid 3 -> mkdir d2 0o777
Pid 3 -> open_close f1 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> mkdir /dir_r__/d3 0o777
Pid 3 -> mkdir /dir_r__/d4 0o777
Pid 3 -> open_close /dir_r__/f3 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close /dir_r__/f4 [O_RDWR;O_CREAT;O_EXCL] 0o666



# _wx
Pid 2 -> mkdir /dir__wx/ 0o777
Pid 2 -> chdir /dir__wx
Pid 3 -> chdir /dir__wx
Pid 2 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> open_close f4 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> mkdir d2 0o777
Pid 2 -> mkdir d4 0o777
Pid 2 -> chmod /dir__wx/ -------wx

Pid 3 -> mkdir d1 0o777
Pid 3 -> mkdir d2 0o777
Pid 3 -> open_close f1 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> mkdir /dir__wx/d3 0o777
Pid 3 -> mkdir /dir__wx/d4 0o777
Pid 3 -> open_close /dir__wx/f3 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close /dir__wx/f4 [O_RDWR;O_CREAT;O_EXCL] 0o666



# _w_
Pid 2 -> mkdir /dir__w_/ 0o777
Pid 2 -> chdir /dir__w_
Pid 3 -> chdir /dir__w_
Pid 2 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> open_close f4 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> mkdir d2 0o777
Pid 2 -> mkdir d4 0o777
Pid 2 -> chmod /dir__w_/ -------w-

Pid 3 -> mkdir d1 0o777
Pid 3 -> mkdir d2 0o777
Pid 3 -> open_close f1 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> mkdir /dir__w_/d3 0o777
Pid 3 -> mkdir /dir__w_/d4 0o777
Pid 3 -> open_close /dir__w_/f3 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close /dir__w_/f4 [O_RDWR;O_CREAT;O_EXCL] 0o666


# __x
Pid 2 -> mkdir /dir___x/ 0o777
Pid 2 -> chdir /dir___x
Pid 3 -> chdir /dir___x
Pid 2 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> open_close f4 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> mkdir d2 0o777
Pid 2 -> mkdir d4 0o777
Pid 2 -> chmod /dir___x/ --------x

Pid 3 -> mkdir d1 0o777
Pid 3 -> mkdir d2 0o777
Pid 3 -> open_close f1 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> mkdir /dir___x/d3 0o777
Pid 3 -> mkdir /dir___x/d4 0o777
Pid 3 -> open_close /dir___x/f3 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close /dir___x/f4 [O_RDWR;O_CREAT;O_EXCL] 0o666


# ___
Pid 2 -> mkdir /dir____/ 0o777
Pid 2 -> chdir /dir____
Pid 3 -> chdir /dir____
Pid 2 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> open_close f4 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 2 -> mkdir d2 0o777
Pid 2 -> mkdir d4 0o777
Pid 2 -> chmod /dir____/ ---------

Pid 3 -> mkdir d1 0o777
Pid 3 -> mkdir d2 0o777
Pid 3 -> open_close f1 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close f2 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> mkdir /dir____/d3 0o777
Pid 3 -> mkdir /dir____/d4 0o777
Pid 3 -> open_close /dir____/f3 [O_RDWR;O_CREAT;O_EXCL] 0o666
Pid 3 -> open_close /dir____/f4 [O_RDWR;O_CREAT;O_EXCL] 0o666
