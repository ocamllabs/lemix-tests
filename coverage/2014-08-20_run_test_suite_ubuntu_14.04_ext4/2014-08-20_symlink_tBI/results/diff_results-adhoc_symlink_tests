        # adhoc_link_tests

        # initialization

     5: mkdir /dir_1 0o777
        Tau
        RV_none

     6: mkdir /dir_1/dir_11 0o777
        Tau
        RV_none

     7: mkdir /dir_2 0o777
        Tau
        RV_none


     9: open /dir_1/f1.txt [O_CREAT;O_RDWR] 0o666
        Tau
        RV_num(3)

    10: write! (FD 3) "content of /dir_1/f1.txt" 24
        Tau
        RV_num(24)

    11: close (FD 3)
        Tau
        RV_none


    13: open /dir_1/f2.txt [O_CREAT;O_RDWR] 0o666
        Tau
        RV_num(3)

    14: write! (FD 3) "content of /dir_1/f2.txt" 24
        Tau
        RV_num(24)

    15: close (FD 3)
        Tau
        RV_none


    17: open /dir_2/f1.txt [O_CREAT;O_RDWR] 0o666
        Tau
        RV_num(3)

    18: write! (FD 3) "content of /dir_2/f1.txt" 24
        Tau
        RV_num(24)

    19: close (FD 3)
        Tau
        RV_none



        ###################################################
        # simple tests, that mimic common use-cases
        ###################################################

        # create a symlink to an existing file an read the file
        # through the symlink

    29: symlink /dir_1/f1.txt /symlink_1
        Tau
        RV_none

    30: open /symlink_1 [O_RDONLY]
        Tau
        RV_num(3)

    31: pread! (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    32: close (FD 3)
        Tau
        RV_none


        # try two indirections
    35: symlink /symlink_1 /symlink_2
        Tau
        RV_none

    36: open /symlink_2 [O_RDONLY]
        Tau
        RV_num(3)

    37: pread! (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    38: close (FD 3)
        Tau
        RV_none

    39: dump-result 
           /|D|3935847
           /symlink_1|L|/dir_1/f1.txt
           /symlink_2|L|/symlink_1
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result

        # remove symlink 1 and read symlink 2
    42: unlink /symlink_1
        Tau
        RV_none

    43: open /symlink_2 [O_RDONLY]
        Tau
        ENOENT

    44: pread! (FD 3) 1000 0
        Tau
        EBADF

    45: close (FD 3)
        Tau
        EBADF

    46: dump-result 
           /|D|3935847
           /symlink_2|L|/symlink_1
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result

        # now try symbolic links to a directory
    49: symlink /dir_1 /symlink_1
        Tau
        RV_none


    51: open /symlink_1/f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    52: pread! (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    53: close (FD 3)
        Tau
        RV_none


    55: open /symlink_2/f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    56: pread! (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    57: close (FD 3)
        Tau
        RV_none


        # renaming of symbolic links renames links not pointed to files
    60: rename /symlink_2 /symlink_2b
        Tau
        RV_none

    61: dump-result 
           /|D|3935847
           /symlink_1|L|/dir_1
           /symlink_2b|L|/symlink_1
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result
    62: open /symlink_2b/f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    63: pread! (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    64: close (FD 3)
        Tau
        RV_none


    66: open /dir_1/f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    67: pread! (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    68: close (FD 3)
        Tau
        RV_none


    70: open /symlink_2/f1.txt [O_RDONLY]
        Tau
        ENOENT

    71: pread! (FD 3) 1000 0
        Tau
        EBADF

    72: close (FD 3)
        Tau
        EBADF


    74: dump-result 
           /|D|3935847
           /symlink_1|L|/dir_1
           /symlink_2b|L|/symlink_1
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result


        # try relative symbolic links
    78: symlink f2.txt /dir_1/symlink_f2.txt
        Tau
        RV_none

    79: open /dir_1/symlink_f2.txt [O_RDONLY]
        Tau
        RV_num(3)

    80: pread! (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f2.txt")

    81: close (FD 3)
        Tau
        RV_none


    83: symlink ../dir_2/f1.txt /dir_1/symlink_d2_f1.txt
        Tau
        RV_none

    84: open /dir_1/symlink_d2_f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    85: pread! (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_2/f1.txt")

    86: close (FD 3)
        Tau
        RV_none


        # read the content of symbolic links
    89: readlink /symlink_1
        Tau
        RV_bytes("/dir_1")

    90: readlink /symlink_1/
        Tau
        EINVAL

    91: readlink /no_such_link
        Tau
        ENOENT

    92: readlink /symlink_1b
        Tau
        ENOENT

    93: readlink /symlink_1b/
        Tau
        ENOENT

    94: readlink /dir_1/symlink_f2.txt
        Tau
        RV_bytes("f2.txt")

    95: readlink /dir_1/symlink_d2_f1.txt
        Tau
        RV_bytes("../dir_2/f1.txt")


        # cleanup
    98: dump-result 
           /|D|3935847
           /symlink_1|L|/dir_1
           /symlink_2b|L|/symlink_1
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/symlink_d2_f1.txt|L|../dir_2/f1.txt
           /dir_1/symlink_f2.txt|L|f2.txt
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result
    99: unlink /symlink_1
        Tau
        RV_none

   100: unlink /symlink_2b
        Tau
        RV_none

   101: unlink /dir_1/symlink_f2.txt
        Tau
        RV_none

   102: unlink /dir_1/symlink_d2_f1.txt
        Tau
        RV_none

   103: dump-result 
           /|D|3935847
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result


        ###################################################
        # testing for corners
        ###################################################

        # linking to non-existing is OK
   111: symlink /no_such_dir/ /slink_no_such1
        Tau
        RV_none

   112: symlink /no_such_file /slink_no_such2
        Tau
        RV_none

   113: chdir /slink_no_such1
        Tau
        ENOENT

   114: chdir /slink_no_such1/
        Tau
        ENOENT

   115: chdir /slink_no_such2
        Tau
        ENOENT

   116: chdir /slink_no_such2/
        Tau
        ENOENT

   117: chdir /slink_no_such1/something_else
        Tau
        ENOENT

   118: chdir /slink_no_such1/something_else/
        Tau
        ENOENT

   119: mkdir /slink_no_such1/ 0o777
        Tau
        EEXIST

   120: mkdir /slink_no_such1/ss 0o777
        Tau
        ENOENT

   121: mkdir /slink_no_such1 0o777
        Tau
        EEXIST

   122: mkdir /slink_no_such2/ 0o777
        Tau
        EEXIST

   123: mkdir /slink_no_such2/ss 0o777
        Tau
        ENOENT

   124: mkdir /slink_no_such2 0o777
        Tau
        EEXIST

   125: unlink /slink_no_such1
        Tau
        RV_none

   126: unlink /slink_no_such2
        Tau
        RV_none

   127: dump-result 
           /|D|3935847
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result

        # existing files and dirs canot be overriden by symlink
   130: symlink /dir_1 /dir_2
        Tau
        EEXIST

   131: symlink /dir_1 /dir_1/f1.txt
        Tau
        EEXIST

   132: symlink /dir_1 /dir_1/symlink.txt
        Tau
        RV_none

   133: symlink /dir_2 /dir_1/symlink.txt
        Tau
        EEXIST

   134: unlink /dir_1/symlink.txt
        Tau
        RV_none

   135: dump-result 
           /|D|3935847
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result

        # the new link name must not end with a slash
   138: symlink xyz /slink_1
        Tau
        RV_none

   139: symlink xyz /slink_2/
        Tau
        ENOENT

   140: unlink /slink_1
        Tau
        RV_none

   141: dump-result 
           /|D|3935847
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result

        # cyclic links can be created, but raise ELOOP when followed
   144: symlink /cyclic_link1 /cyclic_link2
        Tau
        RV_none

   145: symlink /cyclic_link2 /cyclic_link1
        Tau
        RV_none

   146: chdir /cyclic_link1
        Tau
        ELOOP

   147: unlink /cyclic_link1
        Tau
        RV_none

   148: unlink /cyclic_link2
        Tau
        RV_none

   149: dump-result 
           /|D|3935847
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result

        # playing around with trailing slashes
   152: symlink /dir_1/f1.txt /filelink
        Tau
        RV_none

   153: symlink /dir_1 /dirlink
        Tau
        RV_none

   154: dump-result 
           /|D|3935847
           /dirlink|L|/dir_1
           /filelink|L|/dir_1/f1.txt
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result

   156: open_close /filelink [O_RDONLY]
        Tau
        RV_none

   157: open_close /filelink [O_RDONLY]
        Tau
        RV_none


   159: chdir /dirlink
        Tau
        RV_none

   160: chdir /dirlink/
        Tau
        RV_none

   161: open_close f1.txt [O_RDONLY]
        Tau
        RV_none

   162: unlink /dirlink
        Tau
        RV_none

   163: unlink /filelink
        Tau
        RV_none

   164: chdir /
        Tau
        RV_none

   165: dump-result 
           /|D|3935847
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result

        # follow a symlink to a dir and then go to parent dir
   168: symlink /dir_1/dir_11 /dirlink
        Tau
        RV_none

   169: chdir /dirlink
        Tau
        RV_none

   170: chdir ..
        Tau
        RV_none

        # we should be in /dir_1 now, not /, so we can read f1.txt
   172: open_close f1.txt [O_RDONLY]
        Tau
        RV_none

   173: open_close dir_1/f1.txt [O_RDONLY]
        Tau
        ENOENT

   174: unlink /dirlink
        Tau
        RV_none

   175: dump-result 
           /|D|3935847
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|24|3f8cf820bb3ad6f52314a560e757adf6c0548d42
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result


        ###################################################
        # whether a symbolic link that occurs as the last
        # component of a resolved path is followed depends
        # on the command, so test it for all commands
        ###################################################

   184: symlink /dir_1 /dir_link
        Tau
        RV_none

   185: symlink /dir_1/f1.txt /file_link
        Tau
        RV_none


   187: link /dir_1 /dir_3
        Tau
        EPERM

   188: link /dir_link /dir_4
        Tau
        RV_none

   189: link /dir_1/f1.txt /f1.txt
        Tau
        RV_none

   190: link /file_link /f2.txt
        Tau
        RV_none


   192: mkdir /dir_link 0o777
        Tau
        EEXIST

   193: mkdir /file_link 0o777
        Tau
        EEXIST

   194: mkdir /dir_1 0o777
        Tau
        EEXIST

   195: mkdir /dir_1/f1.txt 0o777
        Tau
        EEXIST


   197: symlink /dir_5 /new_dir_link
        Tau
        RV_none

   198: mkdir /new_dir_link 0o777
        Tau
        EEXIST


   200: symlink /f_5 /new_file_link_1
        Tau
        RV_none

   201: symlink /f_6 /new_file_link_2
        Tau
        RV_none

   202: open_close /new_file_link_1 [O_CREAT;O_RDWR] 0o666
        Tau
        RV_none

   203: symlink xyz /new_file_link_2
        Tau
        EEXIST


   205: stat /dir_link
        Tau
        { st_dev=2052; st_ino=3935999; st_kind=S_IFDIR; st_perm=0o755; st_nlink=3; st_uid=0; st_gid=0; st_rdev=0; st_size=4096; }

   206: stat /file_link
        Tau
        { st_dev=2052; st_ino=3936000; st_kind=S_IFREG; st_perm=0o644; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=24; }


   208: truncate /file_link 0
        Tau
        RV_none

   209: stat /file_link
        Tau
        { st_dev=2052; st_ino=3936000; st_kind=S_IFREG; st_perm=0o644; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }

   210: dump-result 
           /|D|3935847
           /dir_4|L|/dir_1
           /dir_link|L|/dir_1
           /f1.txt|F|3936000|0|da39a3ee5e6b4b0d3255bfef95601890afd80709
           /f2.txt|L|/dir_1/f1.txt
           /f_5|F|3948782|0|da39a3ee5e6b4b0d3255bfef95601890afd80709
           /file_link|L|/dir_1/f1.txt
           /new_dir_link|L|/dir_5
           /new_file_link_1|L|/f_5
           /new_file_link_2|L|/f_6
           /dir_1|D|3935999
           /dir_1/f1.txt|F|3936000|0|da39a3ee5e6b4b0d3255bfef95601890afd80709
           /dir_1/f2.txt|F|3936001|24|643494cc13ad08ccb3f11680caf2f3a8b294b994
           /dir_1/dir_11|D|4067084
           /dir_2|D|4196363
           /dir_2/f1.txt|F|4196364|24|727703159e2b79582d71e169cf66473ba9f4ee5c
        end dump-result


trace accepted
