###########################################
# Testing chmod
###########################################

# try chmod with different values on an exiting file,
# an existing directory, something non-existing and
# a symbolic link. Also test that it is not affected
# by the current umask


# Initialisation

mkdir /dir 0o777
Tau
RV_none

open /file.txt [O_CREAT;O_RDWR] 0o777
Tau
RV_num(3)

close (FD 3)
Tau
RV_none

symlink /file.txt /sl
Tau
RV_none

umask 0o022
Tau
RV_file_perm(0o022)


# test initial permissions

stat /dir
Tau
{ st_dev=2052; st_ino=4067084; st_kind=S_IFDIR; st_perm=0o755; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=4096; }

stat /file.txt
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o755; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }

stat /sl
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o755; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }



# Test 1
chmod /dir 0o000
Tau
RV_none

stat /dir
Tau
{ st_dev=2052; st_ino=4067084; st_kind=S_IFDIR; st_perm=0o000; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=4096; }


# Test 2
chmod /dir 0o777
Tau
RV_none

stat /dir
Tau
{ st_dev=2052; st_ino=4067084; st_kind=S_IFDIR; st_perm=0o777; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=4096; }


# Test 3
chmod /dir 0o755
Tau
RV_none

stat /dir
Tau
{ st_dev=2052; st_ino=4067084; st_kind=S_IFDIR; st_perm=0o755; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=4096; }


# Test 4
chmod /file.txt 0o000
Tau
RV_none

stat /file.txt
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o000; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }

stat /sl
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o000; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }


# Test 5
chmod /file.txt 0o666
Tau
RV_none

stat /file.txt
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o666; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }

stat /sl
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o666; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }


# Test 6
chmod /file.txt 0o644
Tau
RV_none

stat /file.txt
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o644; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }

stat /sl
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o644; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }


# Test 7
chmod /no_such_dir/ 0o755
Tau
ENOENT


# Test 8
chmod /no_such_file 0o755
Tau
ENOENT



# try again with different umask
umask 0o000
Tau
RV_file_perm(0o022)


# Test 1
chmod /dir 0o000
Tau
RV_none

stat /dir
Tau
{ st_dev=2052; st_ino=4067084; st_kind=S_IFDIR; st_perm=0o000; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=4096; }


# Test 2
chmod /dir 0o777
Tau
RV_none

stat /dir
Tau
{ st_dev=2052; st_ino=4067084; st_kind=S_IFDIR; st_perm=0o777; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=4096; }


# Test 3
chmod /dir 0o755
Tau
RV_none

stat /dir
Tau
{ st_dev=2052; st_ino=4067084; st_kind=S_IFDIR; st_perm=0o755; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=4096; }


# Test 4
chmod /file.txt 0o000
Tau
RV_none

stat /file.txt
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o000; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }

stat /sl
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o000; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }


# Test 5
chmod /file.txt 0o666
Tau
RV_none

stat /file.txt
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o666; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }

stat /sl
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o666; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }


# Test 6
chmod /file.txt 0o644
Tau
RV_none

stat /file.txt
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o644; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }

stat /sl
Tau
{ st_dev=2052; st_ino=3944383; st_kind=S_IFREG; st_perm=0o644; st_nlink=1; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }


# Test 7
chmod /no_such_dir/ 0o755
Tau
ENOENT


# Test 8
chmod /no_such_file 0o755
Tau
ENOENT

